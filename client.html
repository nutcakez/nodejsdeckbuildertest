<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div id="lobby">
<button onclick='Createroom()'>Create room</button>
<br>
<div id="playground">
    <span id="currentroom"></span>
    <div id="rooms">   
    </div>
</div>
</div>

<div class="gameboard">
    <div id="card0" class="cards" onclick="cardclick(0)">

    </div>
    <div id="card1" class="cards" onclick="cardclick(1)">

    </div>
    <div id="card2" class="cards" onclick="cardclick(2)">

    </div>
    <div id="buy0" class="buycard" onclick="cardbuyclick(0)">

    </div>
    <div id="buy1" class="buycard" onclick="cardbuyclick(1)">

    </div>
    <div id="buy2" class="buycard" onclick="cardbuyclick(2)">

    </div>
    <button id="responsebutton" onclick="sendresponse()">Send response</button>
</div>
<div class="statusboard">
    <h2 id="timer"></h2>
    <h2 id="gold">Gold: </h2>
    <h2 id="life">Life: </h2>
</div>


<label id="myid"></label>


<script src="clientcards.js"></script>
<script
  src="https://code.jquery.com/jquery-3.4.1.js"
  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
  crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<link rel="stylesheet"  href="style.css">
<script>
    $(function(){
        
    })
    var socket=io('https://dof-test.herokuapp.com');
    let id;
    let currentroomID;
    let timercontroll;
    let selected=[];
    let sentData=[];
    let gold=10;
    let life=20;
    let enemy1life=20;
    let enemy1gold=10;
    socket.on('availablerooms',function(data){
        console.log(data)
        DisplayRooms(data.rooms);
    })

    socket.on('ownID',function(data){
        alert(data)
    })

    socket.on('connectedroom',function(data){
        currentroomID=data;
        $('#currentroom').text("Current room is: "+currentroomID)
    })
    socket.on('hand',function(data){
        selected=[]
        sentData=data
        $('#lobby').hide();
        $('.buycard').slideUp(1000,function(){
            $('.cards').slideDown(1000)
        })
        $('.statusboard').show();
        $('.gameboard').show();
        $('.cards').empty();
        for(let i=0;i<data.length;i++){
            $('#card'+i).append("<p>"+Cards[data[i]].name+"</p><p>Cost: "+Cards[data[i]].cost+"</p><p>Attack: "+Cards[data[i]].attack+"</p><p>Life : "+Cards[data[i]].life+"</p>")
        }
        $('#timer').text(6)
        timercontroll=setInterval(TimerCountdown, 1000);
    })


    socket.on('buyround',function(data){
        sentData=data;
        $('.buycard').empty()
        for(let i=0;i<data.length;i++){
            $('#buy'+i).append("<p>"+Cards[data[i]].name+"</p><p>Cost: "+Cards[data[i]].cost+"</p><p>Attack: "+Cards[data[i]].attack+"</p><p>Life : "+Cards[data[i]].life+"</p>")
        }
        $('.cards').slideUp(1000,function(){
            $('.buycard').slideDown(1000)
        })
        $('#timer').text(6)
        timercontroll=setInterval(TimerCountdown, 1000);
    })

    //restart the state
    socket.on('gamestart',function(){
        gold=10;
        life=20;
        $('#gold').html("Gold: "+gold)
        $('#life').html("Life: "+life)
    })
 
    socket.on('connected',function(data){
        id=data;
    })
   
    socket.on('status',function(data){
        console.log(data)
    })



    function Createroom(){
        console.log("Create room pressed");
        socket.emit('CreateNewRoom');
    }

    function selfmessage(){
        alert(Cards[0].name)
        socket.emit('mymessage');
    }


   function DisplayRooms(roomarray){
     $('#rooms').remove();
     $('#playground').append("<div id='rooms'></div)")


    for (let i = 0; i < roomarray.length; i++) {
        $('#rooms').append("<span onclick=joinroom('"+roomarray[i].roomid+"')>"+roomarray[i].roomid+" "+roomarray[i].users+"/4</span><br>")
     
    }    


        
  
        
   }

   function test(){
       $('.cards').hide()
       $('.cards').slideDown()
   }

   function joinroom(id){
        console.log("sending joinroom");
        socket.emit('joinroom',{'room':id});
        currentroomID=id
        $('#currentroom').text("Current room is: "+currentroomID)
   }


   function response(value){
        socket.emit('response',value);
   }

   function cardclick(clickedcard){
       if($('#card'+clickedcard).css("background-color")=="rgb(138, 43, 226)"){
           selected.push(clickedcard)
           console.log(selected)
           $('#card'+clickedcard).css("background-color","green")
           if(gold>=Cards[sentData[clickedcard]].cost){
               gold=gold-Cards[sentData[clickedcard]].cost
               $('#gold').html("Gold: "+gold)
           }
           else
           {
              $('#card'+clickedcard).fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100)
           }
       }else{
           $('#card'+clickedcard).css("background-color","rgb(138, 43, 226)")
           for(let i=0;i<selected.length;i++){
               if(selected[i]==clickedcard){
                   selected.splice(i,1)
                   console.log(selected)
                   break;
               }
           }
            gold=gold+Cards[sentData[clickedcard]].cost
            $('#gold').html("Gold: "+gold)
       }
       
   }

   function cardbuyclick(clickedcard){
       //alert($('#buy'+clickedcard).css("background-color"))
        if($('#buy'+clickedcard).css("background-color")=="rgb(30, 144, 255)"){
           selected.push(clickedcard)
           console.log(selected)
           $('#buy'+clickedcard).css("background-color","green")
           if(gold>=Cards[sentData[clickedcard]].cost){
               gold=gold-Cards[sentData[clickedcard]].cost
               $('#gold').html("Gold: "+gold)
           }
           else
           {
              $('#buy'+clickedcard).fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100)
           }
       }else{
           $('#buy'+clickedcard).css("background-color","rgb(30, 144, 255)")
          
           for(let i=0;i<selected.length;i++){
               if(selected[i]==clickedcard){
                   selected.splice(i,1)
                   console.log(selected)
                   break;
               }
           }
            gold=gold+Cards[sentData[clickedcard]].cost
            $('#gold').html("Gold: "+gold)
       }
   }

   function TimerCountdown(){
       let currentNumber=$('#timer').text()
       $('#timer').text(currentNumber-1)
       if(currentNumber-1==0){
            sendresponse()
       }    
   }

   function sendresponse(){
       clearInterval(timercontroll)
       socket.emit('response',selected)
       selected=[];
   }
</script>